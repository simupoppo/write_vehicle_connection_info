<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>simutrans é€£çµç”¨datè‡ªå‹•è¨˜è¿°ã‚¢ãƒ—ãƒª</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    .item, .relation-entry {
      display: grid;
      grid-template-columns: 80px 40px 40px 80px 60px;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }
    .relation-entry {
      grid-template-columns: 1fr auto;
    }
    button {
      cursor: pointer;
    }
    #result, #output {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #888;
      background-color: #f5f5f5;
      white-space: pre-wrap;
    }
    #textList {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>simutrans é€£çµç”¨datè‡ªå‹•è¨˜è¿°ã‚¢ãƒ—ãƒª</h2>

  <form id="textForm">
    <input type="text" id="textInput" placeholder="ã“ã“ã«æ–‡å­—ã‚’å…¥åŠ›" required>
    <button type="submit">è¿½åŠ </button>
  </form>

  <div id="textList"></div>

  <button id="selectButton">é¸æŠ</button>

  <div id="result">
    <h3>é–¢é€£ä»˜ã‘ç¢ºèªæ¬„:</h3>
    <div id="relationList"></div>
  </div>
    
  <button id="outputButton">å‡ºåŠ›</button>

  <div id="output">
    <h3>çµæœ:</h3>
    <div id="outputText"></div>
  </div>

  <script>
    const form = document.getElementById("textForm");
    const input = document.getElementById("textInput");
    const textList = document.getElementById("textList");
    const selectButton = document.getElementById("selectButton");
    const relationList = document.getElementById("relationList");
    const outputButton = document.getElementById("outputButton");
    const outputText = document.getElementById("outputText");

    const relations = new Set(); // ä¿å­˜å½¢å¼: "è¦ª->å­"
    const nameSet = new Set(); // é‡è¤‡é˜²æ­¢ç”¨ã®åå‰é›†åˆ

    form.addEventListener("submit", function(event) {
      event.preventDefault();
      const newText = input.value.trim();
      if (newText === "") return;

      if (nameSet.has(newText)) {
        alert(`"${newText}" ã¯ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
        return;
      }

      nameSet.add(newText);

      const itemDiv = document.createElement("div");
      itemDiv.className = "item";
      itemDiv.setAttribute("data-name", newText);

      const labelLeft = document.createElement("span");
      labelLeft.textContent = newText;

      const checkbox1 = document.createElement("input");
      checkbox1.type = "checkbox"; // è¦ª

      const checkbox2 = document.createElement("input");
      checkbox2.type = "checkbox"; // å­

      const labelRight = document.createElement("span");
      labelRight.textContent = newText;

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "å‰Šé™¤";
      deleteBtn.type = "button";
      deleteBtn.addEventListener("click", function () {
        textList.removeChild(itemDiv);
        nameSet.delete(newText);

        // é–¢é€£ã‚‚å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šå‰Šé™¤ã—ãªã„ãªã‚‰ã“ã®éƒ¨åˆ†ã¯å‰Šé™¤å¯ï¼‰
        [...relations].forEach(key => {
          if (key.startsWith(newText + "->") || key.endsWith("->" + newText)) {
            relations.delete(key);
            // é–¢é€£è¡¨ç¤ºæ¬„ã‚‚æ›´æ–°
            document.querySelectorAll('.relation-entry').forEach(entry => {
              if (entry.getAttribute('data-key') === key) {
                entry.remove();
              }
            });
          }
        });
      });

      itemDiv.appendChild(labelLeft);
      itemDiv.appendChild(checkbox1);
      itemDiv.appendChild(checkbox2);
      itemDiv.appendChild(labelRight);
      itemDiv.appendChild(deleteBtn);

      textList.appendChild(itemDiv);
      input.value = "";
    });

    selectButton.addEventListener("click", function () {
      const items = document.querySelectorAll(".item");
      let parents = [];
      let children = [];

      items.forEach(item => {
        const checkboxes = item.querySelectorAll("input[type='checkbox']");
        const name = item.getAttribute("data-name");
        if (checkboxes[0].checked) parents.push(name);
        if (checkboxes[1].checked) children.push(name);
      });

      if (parents.length === 0 || children.length === 0) {
        alert("è¦ªã¾ãŸã¯å­ã®ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      parents.forEach(parent => {
        children.forEach(child => {
          const key = `${parent}->${child}`;
          if (!relations.has(key)) {
            relations.add(key);
            const entry = document.createElement("div");
            entry.className = "relation-entry";
            entry.setAttribute("data-key", key);

            const msg = document.createElement("span");
            msg.textContent = `${parent} ãŒ ${child} ã¨é–¢é€£ä»˜ã‘ã•ã‚Œã¾ã—ãŸã€‚`;

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "å‰Šé™¤";
            deleteBtn.addEventListener("click", function () {
              relationList.removeChild(entry);
              relations.delete(key);
            });

            entry.appendChild(msg);
            entry.appendChild(deleteBtn);
            relationList.appendChild(entry);
          }
        });
      });

      // ğŸ”„ ãƒã‚§ãƒƒã‚¯ã‚’ã™ã¹ã¦å¤–ã™
      items.forEach(item => {
        const checkboxes = item.querySelectorAll("input[type='checkbox']");
        checkboxes[0].checked = false;
        checkboxes[1].checked = false;
      });
    });

    outputButton.addEventListener("click", function () {
      const allNames = Array.from(nameSet);
      const parentsMap = {};
      const childrenMap = {};

      relations.forEach(relation => {
        const [parent, child] = relation.split("->");
        if (!childrenMap[parent]) childrenMap[parent] = [];
        if (!parentsMap[child]) parentsMap[child] = [];
        childrenMap[parent].push(child);
        parentsMap[child].push(parent);
      });

      let output = "";
      const sortedNames = allNames.sort();

      sortedNames.forEach(name => {
        output += "------\n";
        output += `#${name}\n`;

        const prevList = parentsMap[name] || [];
        prevList.forEach((p, i) => {
          output += `Constraint[prev][${i}]=${p}\n`;
        });

        const nextList = childrenMap[name] || [];
        nextList.forEach((c, i) => {
          output += `Constraint[next][${i}]=${c}\n`;
        });
      });

      outputText.textContent = output || "(é–¢é€£ä»˜ã‘ãŒã‚ã‚Šã¾ã›ã‚“)";
    });
  </script>


</body>
</html>
