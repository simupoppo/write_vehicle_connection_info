<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>simutrans 連結用dat自動記述アプリ</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.2/full/pyodide.js"></script>
</head>
<body>

  <h2>simutrans 連結用dat自動記述アプリ</h2>

  <form id="textForm">
    <input type="text" id="textInput" placeholder="ここに文字を入力" required>
    <button type="submit">追加</button>
  </form>

  <div id="textList"></div>

  <button id="selectButton">選択</button>

  <div id="result">
    <h3>関連付け確認欄:</h3>
    <div id="relationList"></div>
  </div>

  <script>
    const form = document.getElementById("textForm");
    const input = document.getElementById("textInput");
    const textList = document.getElementById("textList");
    const selectButton = document.getElementById("selectButton");
    const relationList = document.getElementById("relationList");

    // 登録された関係を記録するセット（"親->子" 形式）
    const relations = new Set();

    form.addEventListener("submit", function(event) {
      event.preventDefault();

      const newText = input.value.trim();
      if (newText !== "") {
        const itemDiv = document.createElement("div");
        itemDiv.className = "item";

        const labelLeft = document.createElement("span");
        labelLeft.textContent = newText;

        const checkbox1 = document.createElement("input");
        checkbox1.type = "checkbox"; // 親

        const checkbox2 = document.createElement("input");
        checkbox2.type = "checkbox"; // 子

        const labelRight = document.createElement("span");
        labelRight.textContent = newText;

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "削除";
        deleteBtn.type = "button";
        deleteBtn.addEventListener("click", function () {
          textList.removeChild(itemDiv);
        });

        itemDiv.setAttribute("data-name", newText);

        itemDiv.appendChild(labelLeft);
        itemDiv.appendChild(checkbox1);
        itemDiv.appendChild(checkbox2);
        itemDiv.appendChild(labelRight);
        itemDiv.appendChild(deleteBtn);

        textList.appendChild(itemDiv);
        input.value = "";
      }
    });

    selectButton.addEventListener("click", function () {
      const items = document.querySelectorAll(".item");
      let parents = [];
      let children = [];

      items.forEach(item => {
        const checkboxes = item.querySelectorAll("input[type='checkbox']");
        const name = item.getAttribute("data-name");
        if (checkboxes[0].checked) {
          parents.push(name);
        }
        if (checkboxes[1].checked) {
          children.push(name);
        }
      });

      if (parents.length === 0 || children.length === 0) {
        alert("親または子のチェックがありません。");
        return;
      }

      parents.forEach(parent => {
        children.forEach(child => {
          const key = `${parent}->${child}`;
          if (!relations.has(key)) {
            relations.add(key);
            const entry = document.createElement("div");
            entry.className = "relation-entry";
            entry.setAttribute("data-key", key);

            const msg = document.createElement("span");
            msg.textContent = `${parent} が ${child} と関連付けされました。`;

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "削除";
            deleteBtn.addEventListener("click", function () {
              relationList.removeChild(entry);
              relations.delete(key);
            });

            entry.appendChild(msg);
            entry.appendChild(deleteBtn);
            relationList.appendChild(entry);
          }
        });
      });

      // すべてのチェックをリセット
      items.forEach(item => {
        const checkboxes = item.querySelectorAll("input[type='checkbox']");
        checkboxes[0].checked = false;
        checkboxes[1].checked = false;
      });
    });
  </script>


</body>
</html>
